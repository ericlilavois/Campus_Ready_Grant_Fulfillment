<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customize Your Kit - Campus Ready Foundation</title>
    <link rel="icon" type="image/x-icon" href="CRF_icon_144_x_144.jpg">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --teal: #469E92;
            --teal-dark: #3a8178;
            --black: #231F20;
            --grey-light: #F9FAFB;
            --grey-border: #E5E7EB;
            --grey-text: #6B7280;
            --white: #FFFFFF;
            --error: #DC2626;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--white);
            color: var(--black);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 24px 16px;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo {
            max-width: 300px;
            width: 100%;
            height: auto;
            margin: 0 auto 24px;
            display: block;
        }

        .title {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--black);
            margin-bottom: 16px;
        }

        .subtitle {
            font-size: 1.1rem;
            color: var(--black);
            max-width: 600px;
            margin: 0 auto;
        }

        /* Progress Bar */
        .progress-container {
            margin-bottom: 40px;
            background: var(--grey-light);
            padding: 24px;
            border-radius: 12px;
        }

        .progress-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .progress-step {
            flex: 1;
            text-align: center;
            position: relative;
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--white);
            border: 2px solid var(--grey-border);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 8px;
            font-weight: 600;
            color: var(--grey-text);
            transition: all 0.3s ease;
        }

        .progress-step.active .step-circle {
            background: var(--teal);
            border-color: var(--teal);
            color: var(--white);
        }

        .progress-step.complete .step-circle {
            background: var(--teal);
            border-color: var(--teal);
            color: var(--white);
        }

       .step-label {
            font-size: 0.75rem;
            color: var(--grey-text);
            font-weight: 500;
            white-space: nowrap;
        }

        .progress-step.active .step-label {
            color: var(--teal);
            font-weight: 600;
        }

        .step-arrow {
            color: var(--grey-border);
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        /* Form Card */
        .form-card {
            background: var(--grey-light);
            border-radius: 12px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        /* Sections */
        .form-section {
            display: none;
        }

        .form-section.active {
            display: block;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--black);
            margin-bottom: 8px;
        }

        .section-description {
            color: var(--black);
            margin-bottom: 32px;
            font-size: 1rem;
        }

        /* Form Groups */
        .form-group {
            margin-bottom: 24px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        @media (min-width: 640px) {
            .form-row.cols-2 {
                grid-template-columns: 1fr 1fr;
            }
            
            .form-row.cols-3 {
                grid-template-columns: 2fr 1fr 1fr;
            }
        }

        label {
            display: block;
            font-weight: 500;
            color: var(--black);
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .required::after {
            content: " *";
            color: var(--teal);
        }

        .helper-text {
            font-size: 0.875rem;
            color: var(--black);
            font-size: 0.875rem;
            color: var(--black);
            margin-top: 4px;
            line-height: 1.4;
        }

        .live-error {
            color: var(--error);
            font-weight: 500;
            margin-top: 6px;
            font-size: 0.875rem;
            display: none;
        }

        /* Input Fields */
        input[type="text"],
        input[type="email"] {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--grey-border);
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.2s ease;
            background: var(--white);
        }

        input[type="text"]:focus,
        input[type="email"]:focus {
            outline: none;
            border-color: var(--teal);
            box-shadow: 0 0 0 3px rgba(70, 158, 146, 0.1);
        }

        input.invalid {
            border-color: var(--error);
        }

        .error-message {
            color: var(--error);
            font-size: 0.875rem;
            margin-top: 6px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* Radio Buttons */
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            padding: 14px 16px;
            border: 2px solid var(--grey-border);
            border-radius: 8px;
            background: var(--white);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .radio-option:hover {
            border-color: var(--teal);
            background: rgba(70, 158, 146, 0.03);
        }

        .radio-option input[type="radio"] {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            cursor: pointer;
            accent-color: var(--teal);
        }

        .radio-option label {
            margin: 0;
            cursor: pointer;
            flex: 1;
            font-weight: 400;
        }

        .radio-option input[type="radio"]:checked + label {
            font-weight: 500;
        }

        /* Buttons */
        .button-group {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            margin-top: 32px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 14px 28px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--teal);
            color: var(--white);
            padding: 10px 20px;
        }

        .btn-primary:hover {
            background: var(--teal-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(70, 158, 146, 0.3);
        }

       .btn-secondary {
            background: var(--white);
            color: var(--teal);
            border: 2px solid var(--teal);
            padding: 10px 20px;
        }

        .btn-secondary:hover {
            background: var(--grey-light);
        }

        /* Review Section */
        .review-block {
            background: var(--white);
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 20px;
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--grey-light);
        }

        .review-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--black);
        }

        .edit-link {
            color: var(--teal);
            text-decoration: none;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .edit-link:hover {
            text-decoration: underline;
        }

        .review-item {
            display: grid;
            grid-template-columns: 140px 1fr;
            gap: 12px;
            margin-bottom: 12px;
        }

        .review-label {
            font-weight: 500;
            color: var(--grey-text);
        }

        .review-value {
            color: var(--black);
        }

        /* Success Screen */
        .success-screen {
            display: none;
            text-align: center;
            padding: 60px 20px;
        }

        .success-screen.show {
            display: block;
        }

        .success-icon {
            width: 200px;
            max-width: 90%;
            margin: 0 auto 32px;
        }

        .success-title {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            font-weight: 700;
            color: var(--teal);
            margin-bottom: 16px;
        }

        .success-message {
            font-size: 1.1rem;
            color: var(--grey-text);
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.7;
        }

        /* Loading State */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-content {
            text-align: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--grey-light);
            border-top-color: var(--teal);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.1rem;
            color: var(--grey-text);
        }

        /* Responsive */
        @media (max-width: 640px) {
            .title {
                font-size: 2rem;
            }

            .form-card {
                padding: 24px 20px;
            }

            .progress-bar {
                flex-direction: column;
                gap: 16px;
            }

            .step-arrow {
                transform: rotate(90deg);
            }

            .review-item {
                grid-template-columns: 1fr;
                gap: 4px;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }
        /* Document Upload Styles */
        .upload-help {
            font-size: 0.9rem;
            color: var(--grey-text);
            margin-top: 4px;
            margin-bottom: 12px;
        }

        .file-upload-btn {
            background: var(--white);
            border: 2px solid var(--grey-border);
            color: var(--black);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .file-upload-btn:hover {
            border-color: var(--teal);
            background: var(--grey-light);
        }

        .filename-display {
            margin-top: 8px;
            font-size: 0.9rem;
            color: var(--grey-text);
            font-style: italic;
        }

        .upload-progress {
            margin-top: 12px;
        }

       .upload-progress-bar {
            width: 100%;
            height: 12px;
            background: var(--grey-border);
            border-radius: 8px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--teal);
            width: 0%;
            transition: width 0.3s ease;
        }

        .progress-text {
            margin-top: 8px;
            font-size: 0.9rem;
            color: var(--teal);
            text-align: center;
        }

        .upload-success {
            margin-top: 12px;
            padding: 12px;
            background: #ECFDF5;
            border: 1px solid #10B981;
            border-radius: 8px;
            color: #065F46;
            font-weight: 500;
        }

        .success-checkmark {
            color: #10B981;
            font-weight: bold;
            margin-right: 8px;
        }

        .upload-error {
            margin-top: 8px;
            color: var(--error);
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <img src="logo-image-1200x630.png" alt="Campus Ready Foundation" class="logo">
          <h1 class="title" id="pageTitle">Congratulations!</h1>
            <p class="subtitle" id="pageSubtitle">You've earned your grant. We just need a little more information before we send your awards.</p>        
        </div>

        <!-- Progress Bar -->
        <div class="progress-container">
            <div class="progress-bar">
              <div class="progress-step active" id="step-1">
                    <div class="step-circle">1</div>
                    <div class="step-label">Verify Email</div>
                </div>
                <div class="step-arrow">→</div>
                <div class="progress-step" id="step-2">
                    <div class="step-circle">2</div>
                    <div class="step-label">Upload Documents</div>
                </div>
                <div class="step-arrow">→</div>
                <div class="progress-step" id="step-3">
                    <div class="step-circle">3</div>
                    <div class="step-label">Customize Kit</div>
                </div>
                <div class="step-arrow">→</div>
                <div class="progress-step" id="step-4">
                    <div class="step-circle">4</div>
                    <div class="step-label">Submit</div>
                </div>
             </div>
            </div>

        <!-- Form -->
        <form id="kitForm" class="form-card">
            <!-- EMAIL VALIDATION SECTION -->
            <div id="emailValidation" class="form-section active">
                <h2 class="section-title">Verify Your Email</h2>
                <p class="section-description">
                    Enter the email address you used in your Campus Ready grant application. 
                    This helps us personalize your kit and track your progress.
                </p>
                
                <div class="form-group">
                    <label for="email_verify" class="required">Email Address</label>
                    <input 
                        type="email" 
                        id="email_verify" 
                        name="email_verify" 
                        placeholder="your.email@example.com"
                        autocomplete="email"
                    />
                    <div id="email-verify-error" class="live-error"></div>
                </div>
                
                <button type="button" id="verifyEmailBtn" class="btn btn-primary">                    
                    Verify My Email
                </button>
                
                <div id="email-checking" style="display: none; margin-top: 16px; color: var(--teal); font-weight: 500;">
                    Checking your status...
                </div>
            </div>
            <!-- DOCUMENT UPLOAD SECTION -->
            <div id="documentUpload" class="form-section" style="display: none;">
             <h2 class="section-title">Upload Required Documents</h2>
                
                <!-- Housing Document -->
                <div class="form-group">
                    <label for="housing_doc" class="required">Housing Assignment Confirmation</label>
                    <p class="upload-help">
                   Please upload a letter from your school or screenshot of your school portal indicating your housing assignment. We accept PDF, JPG, or PNG files up to 5MB.
                    </p>
                    <input 
                        type="file" 
                        id="housing_doc" 
                        accept=".pdf,.jpg,.jpeg,.png"
                        style="display: none;"
                    />
                    <button type="button" class="file-upload-btn" onclick="document.getElementById('housing_doc').click()">
                        Choose File
                    </button>
                    <div id="housing_filename" class="filename-display"></div>
                    <div id="housing_progress" class="upload-progress" style="display: none;">
                        <div class="upload-progress-bar">
                            <div id="housing_progress_fill" class="progress-fill"></div>
                        </div>
                        <div id="housing_progress_text" class="progress-text">Uploading...</div>
                    </div>
                   <div id="housing_success" class="upload-success" style="display: none;">
    <img src="CRF_icon_144_x_144.jpg" alt="✓" style="width: 32px; height: 32px; vertical-align: middle; margin-right: 8px;">
    Housing document received
</div>
                    <div id="housing_error" class="upload-error"></div>
                </div>
                
                <!-- Acceptance Letter -->
                <div class="form-group">
                    <label for="acceptance_doc" class="required">College Acceptance Letter</label>
                    <p class="upload-help">
                        Please upload your official confirmation of enrollment. We accept PDF, JPG, or PNG files up to 5MB.
                    </p>
                    <input 
                        type="file" 
                        id="acceptance_doc" 
                        accept=".pdf,.jpg,.jpeg,.png"
                        style="display: none;"
                    />
                    <button type="button" class="file-upload-btn" onclick="document.getElementById('acceptance_doc').click()">
                        Choose File
                    </button>
                    <div id="acceptance_filename" class="filename-display"></div>
                    <div id="acceptance_progress" class="upload-progress" style="display: none;">
                       <div class="upload-progress-bar">
                            <div id="acceptance_progress_fill" class="progress-fill"></div>
                        </div>
                        <div id="acceptance_progress_text" class="progress-text">Uploading...</div>
                    </div>
                 <div id="acceptance_success" class="upload-success" style="display: none;">
<img src="CRF_icon_144_x_144.jpg" alt="✓" style="width: 32px; height: 32px; vertical-align: middle; margin-right: 8px;">    
                     Acceptance letter received
</div>
                    <div id="acceptance_error" class="upload-error"></div>
                </div>
                
                <p class="section-description" style="margin-top: 24px; font-style: italic;">
                    Don't have these yet? No problem - bookmark this page and come back when you do. We'll save your progress.
                </p>
                
                <button type="button" id="continueToKitBtn" class="btn btn-primary" disabled style="margin-top: 24px;">
                    Continue to Kit Selection
                </button>
            </div>
            <!-- Section 1: Personal Information -->
            <div class="form-section" data-section="1">
                <h2 class="section-title">Personal Information</h2>
                <p class="section-description">Please use your full legal name and the mailing address (home or college) where you want to receive your curated move-in essentials kit.</p>

                <div class="form-group">
                    <label for="student_name" class="required">Student Name</label>
                    <input type="text" id="student_name" name="student_name" required placeholder="Enter your full name, as it appeared on your application">
                </div>

                <div class="form-group">
                    <label for="email" class="required">Email Address</label>
                    <input type="email" id="email" name="email" required>
                    <div class="live-error" id="email-live-feedback">Please enter a valid email address.</div>
                </div>

                <div class="form-group">
                    <label class="required">Shipping Preference</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="ship_home" name="shipping_preference" value="Home" required>
                            <label for="ship_home">Home</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="ship_college" name="shipping_preference" value="College" required>
                            <label for="ship_college">College</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="street_address" class="required">Street Address</label>
                    <input type="text" id="street_address" name="street_address" required>
                </div>

                <div class="form-group">
                    <label for="street_address_2">Street Address 2</label>
                    <input type="text" id="street_address_2" name="street_address_2">
                </div>

                <div class="form-row cols-3">
                    <div class="form-group">
                        <label for="city" class="required">City</label>
                        <input type="text" id="city" name="city" required>
                    </div>
                    <div class="form-group">
                        <label for="state" class="required">State</label>
                        <input type="text" id="state" name="state" required maxlength="2" placeholder="CA" style="text-transform: uppercase;">
                        <div class="error-message" id="state-error">Please enter a valid 2-letter state code.</div>
                    </div>
                    <div class="form-group">
                        <label for="zip" class="required">Zip Code</label>
                        <input type="text" id="zip" name="zip" required maxlength="5" placeholder="12345">
                        <div class="live-error" id="zip-live-feedback">Please enter a 5-digit ZIP code.</div>
                        <div class="error-message" id="zip-error">The City, State, and ZIP code combination appears to be invalid.</div>
                    </div>
                </div>

                <div class="helper-text" style="margin-top: -16px; margin-bottom: 24px;">Use your state's two-letter abbreviation, e.g., CA, NY</div>

                <div class="button-group">
                    <div></div>
                    <button type="button" class="btn btn-primary" onclick="nextSection()">Continue to Product Choices</button>
                </div>
            </div>

            <!-- Section 2: Product Choices -->
            <div class="form-section" data-section="2">
                <h2 class="section-title">Product Choices</h2>
                <p class="section-description">This part is important. Your responses will guide us to select items that match your style, ensuring you get products you want for the start to your college journey.</p>

                <div class="form-group">
                    <label class="required">Gender Preference</label>
                    <div class="helper-text">Your response helps us ensure you receive personal care products (e.g., razor systems, deodorant, hygiene) that best suit your needs. Please note, if you choose Prefer Not to Say (PNS) we will send Unisex/Unscented products when possible.</div>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="gender_female" name="gender_preference" value="Female" required>
                            <label for="gender_female">Female</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="gender_male" name="gender_preference" value="Male" required>
                            <label for="gender_male">Male</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="gender_pns" name="gender_preference" value="Prefer Not to Say (PNS)" required>
                            <label for="gender_pns">Prefer Not to Say (PNS)</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="required">Scent Preference</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="scent_fresh" name="scent_preference" value="Fresh & Clean" required>
                            <label for="scent_fresh">Fresh & Clean</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="scent_vanilla" name="scent_preference" value="Vanilla & Botanicals" required>
                            <label for="scent_vanilla">Vanilla & Botanicals</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="scent_unscented" name="scent_preference" value="Unscented" required>
                            <label for="scent_unscented">Unscented</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="required">Deodorant Type</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="deodorant" name="deodorant_type" value="Deodorant" required>
                            <label for="deodorant">Deodorant</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="antiperspirant" name="deodorant_type" value="Antiperspirant" required>
                            <label for="antiperspirant">Antiperspirant</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="required">Style Preference</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="style_modern" name="style_preference" value="Modern & Minimalist" required>
                            <label for="style_modern">Modern & Minimalist</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="style_cozy" name="style_preference" value="Cozy & Warm" required>
                            <label for="style_cozy">Cozy & Warm</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="style_bold" name="style_preference" value="Bold & Colorful" required>
                            <label for="style_bold">Bold & Colorful</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="required">Bedding Color</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="bedding_white" name="bedding_color" value="White" required>
                            <label for="bedding_white">White</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="bedding_gray" name="bedding_color" value="Gray" required>
                            <label for="bedding_gray">Gray</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="bedding_navy" name="bedding_color" value="Navy" required>
                            <label for="bedding_navy">Navy</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="bedding_warm" name="bedding_color" value="Warm" required>
                            <label for="bedding_warm">Warm</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="required">Pillow Firmness</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="pillow_soft" name="pillow_firmness" value="Soft" required>
                            <label for="pillow_soft">Soft</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="pillow_medium" name="pillow_firmness" value="Medium" required>
                            <label for="pillow_medium">Medium</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="pillow_firm" name="pillow_firmness" value="Firm" required>
                            <label for="pillow_firm">Firm</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="required">Towel Color</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="towel_white" name="towel_color" value="White" required>
                            <label for="towel_white">White</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="towel_gray" name="towel_color" value="Gray" required>
                            <label for="towel_gray">Gray</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="towel_navy" name="towel_color" value="Navy" required>
                            <label for="towel_navy">Navy</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="towel_warm" name="towel_color" value="Warm" required>
                            <label for="towel_warm">Warm</label>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="required">Slides Size</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="radio" id="slides_small" name="slides_size" value="Small" required>
                            <label for="slides_small">Small</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="slides_medium" name="slides_size" value="Medium" required>
                            <label for="slides_medium">Medium</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="slides_large" name="slides_size" value="Large" required>
                            <label for="slides_large">Large</label>
                        </div>
                        <div class="radio-option">
                            <input type="radio" id="slides_xl" name="slides_size" value="Extra Large" required>
                            <label for="slides_xl">Extra Large</label>
                        </div>
                    </div>
                </div>

                <div class="button-group">
                    <button type="button" class="btn btn-secondary" onclick="prevSection()">Back</button>
                    <button type="button" class="btn btn-primary" onclick="nextSection()">Review Your Choices</button>
                </div>
            </div>

            <!-- Section 3: Review -->
            <div class="form-section" data-section="3">
                <h2 class="section-title">Review Your Information</h2>
                <p class="section-description">Please review your information before submitting. You can edit any section by clicking the "Edit" link.</p>

                <div class="review-block">
                    <div class="review-header">
                        <h3 class="review-title">Personal Information</h3>
                        <a href="#" class="edit-link" onclick="goToSection(1); return false;">Edit</a>
                    </div>
                    <div id="review-personal"></div>
                </div>

                <div class="review-block">
                    <div class="review-header">
                        <h3 class="review-title">Product Choices</h3>
                        <a href="#" class="edit-link" onclick="goToSection(2); return false;">Edit</a>
                    </div>
                    <div id="review-products"></div>
                </div>

                <div class="button-group">
                    <button type="button" class="btn btn-secondary" onclick="prevSection()">Back to Edit</button>
                    <button type="button" class="btn btn-primary" onclick="submitForm()">Submit Your Kit Preferences</button>
                </div>
            </div>
        </form>

        <!-- Success Screen -->
        <div class="success-screen" id="successScreen">
          <div class="success-icon">
    <img src="prepare-badge.jpg" alt="Prepare to Be Prepared" style="width: 100%; max-width: 200px; height: auto;">
</div>
            <h2 class="success-title">You're Done!</h2>
            <p class="success-message">
                Now we'll get to work. Look for your packages in early August.<br><br>
                <strong>Congratulations again. You've done something monumental by getting into school. We're proud of you!</strong>
            </p>
        </div>

        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-content">
                <div class="spinner"></div>
                <div class="loading-text">Submitting your preferences...</div>
            </div>
        </div>
    </div>

    <script>
        /*
         * ============================================================
         * CUSTOMIZE YOUR KIT - FIXED VERSION
         * ============================================================
         * Base: Customize_Your_Kit (2).html from earlier today
         * 
         * ENHANCEMENTS MADE:
         * 1. Email Live Validation - Real-time feedback as user types
         *    - Uses isValidEmail() from validation.js
         *    - Shows/hides error message dynamically
         *    - Adds 'invalid' class for visual feedback
         * 
         * 2. ZIP Live Validation - Real-time feedback as user types  
         *    - Uses isValidZip() from validation.js
         *    - Shows/hides error message dynamically
         * 
         * PRESERVED FUNCTIONALITY:
         * - All original form navigation and progress tracking
         * - ZIP lookup with city/state auto-fill and confirmation
         * - Critical ZIP/City/State matching validation on submission
         * - All product preferences and review logic
         * - Form submission to Vercel proxy
         * 
         * VALIDATION FLOW:
         * - Live feedback: As user types (non-blocking, informational)
         * - Submit validation: When advancing to next section (blocking)
         *   - Checks email format via isValidEmail()
         *   - Checks ZIP format via isValidZip()
         *   - Verifies ZIP/City/State match via doesZipMatchCityState()
         * ============================================================
         */
        
        // State management
        let currentSection = 1;
        // Dynamic header update function
        function updateHeader(title, subtitle) {
            document.getElementById('pageTitle').textContent = title;
            document.getElementById('pageSubtitle').textContent = subtitle;
        }
        const totalSections = 3;

        // Navigation functions
        function goToSection(sectionNum) {
            // Hide all sections
            document.querySelectorAll('.form-section').forEach(section => {
                section.classList.remove('active');
            });

            // Show target section
            document.querySelector(`[data-section="${sectionNum}"]`).classList.add('active');

            // Update progress bar
            document.querySelectorAll('.progress-step').forEach((step, index) => {
                const stepNum = index + 1;
                step.classList.remove('active', 'complete');
                
                if (stepNum < sectionNum) {
                    step.classList.add('complete');
                } else if (stepNum === sectionNum) {
                    step.classList.add('active');
                }
            });

            // Update current section
            currentSection = sectionNum;

            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });

           // If going to review section, populate review
            if (sectionNum === 3) {
                populateReview();
                updateHeader('Review and Submit', 'Please check your entries and your choices.');
            }
            
            // Update header for kit customization section
            if (sectionNum === 1) {
                updateHeader('Customize Your Kit', "We're going shopping! Your responses will guide us to select items that match your style, ensuring you get products you want for the start to your college journey.");
            }
        }

        async function nextSection() {
            // Validate current section
            if (!await validateSection(currentSection)) {
                return;
            }

            if (currentSection < totalSections) {
                goToSection(currentSection + 1);
            }
        }

        function prevSection() {
            if (currentSection > 1) {
                goToSection(currentSection - 1);
            }
        }

      // Validation functions
async function validateSection(sectionNum) {
    const section = document.querySelector(`[data-section="${sectionNum}"]`);
    // NOTE: input elements are queried here, not select or textarea as they are not used in this form.
    const inputs = section.querySelectorAll('input[required]'); 
    
    // Check all required inputs in the section
    for (const input of inputs) {
        if (input.type === 'radio') {
            const radioGroup = section.querySelectorAll(`input[name="${input.name}"]`);
            const anyChecked = Array.from(radioGroup).some(radio => radio.checked);
            if (!anyChecked) {
                // Scroll to first unchecked radio group and block progress
                input.scrollIntoView({ behavior: 'smooth', block: 'center' });
                return false; // Exit validation
            }
        } else if (!input.value.trim()) {
            // Focus on the missing input and block progress
            input.focus();
            return false; // Exit validation
        }
    }

            // Additional validation for section 1
           // Additional validation for section 1
    if (sectionNum === 1) {
        const emailInput = document.getElementById('email');
        const emailError = document.getElementById('email-live-feedback');
        const state = document.getElementById('state');
        const stateError = document.getElementById('state-error');
        const zip = document.getElementById('zip');
        const zipError = document.getElementById('zip-error');

        // 1. Email validation (Format)
        const emailResult = window.isValidEmail(emailInput.value);
        if (!emailResult.valid) {
            emailInput.classList.add('invalid');
            emailError.textContent = emailResult.message;
            emailError.classList.add('show');
            emailInput.focus();
            return false;
        } else {
            emailInput.classList.remove('invalid');
            emailError.classList.remove('show');
        }

        // 2. State validation (2-letter format - kept local)
        const stateRegex = /^[A-Z]{2}$/;
        if (!stateRegex.test(state.value.toUpperCase())) {
            state.classList.add('invalid');
            stateError.classList.add('show');
            state.focus();
            return false;
        } else {
            state.classList.remove('invalid');
            stateError.classList.remove('show');
        }

        // 3. ZIP validation (5-digit format)
        if (!window.isValidZip(zip.value)) {
            zip.classList.add('invalid');
            zipError.classList.add('show');
            zip.focus();
            return false;
        } else {
            zip.classList.remove('invalid');
            zipError.classList.remove('show');
        }

        // 4. Critical: ZIP, City, State matching (Async API call)
        const city = document.getElementById('city');
        const zipMatches = await window.doesZipMatchCityState(zip.value, city.value, state.value);
        
        if (!zipMatches) {
            // Error handling for unmatched address
            zip.classList.add('invalid');
            city.classList.add('invalid');
            state.classList.add('invalid');
            alert('The City, State, and ZIP code combination you entered appears to be invalid. Please check your address details.');
            return false;
        } else {
            zip.classList.remove('invalid');
            city.classList.remove('invalid');
            state.classList.remove('invalid');
        }
    }

    return true; // Use 'true' to explicitly pass validation on success
}

        // Populate review section
        function populateReview() {
            const form = document.getElementById('kitForm');
            const formData = new FormData(form);

            // Personal Information
            const personalHTML = `
                <div class="review-item">
                    <div class="review-label">Name:</div>
                    <div class="review-value">${formData.get('student_name')}</div>
                </div>
                <div class="review-item">
                    <div class="review-label">Email:</div>
                    <div class="review-value">${formData.get('email')}</div>
                </div>
                <div class="review-item">
                    <div class="review-label">Shipping:</div>
                    <div class="review-value">${formData.get('shipping_preference')}</div>
                </div>
                <div class="review-item">
                    <div class="review-label">Address:</div>
                    <div class="review-value">
                        ${formData.get('street_address')}<br>
                        ${formData.get('street_address_2') ? formData.get('street_address_2') + '<br>' : ''}
                        ${formData.get('city')}, ${formData.get('state')} ${formData.get('zip')}
                    </div>
                </div>
            `;
            document.getElementById('review-personal').innerHTML = personalHTML;

            // Product Choices
            const productsHTML = `
                <div class="review-item">
                    <div class="review-label">Gender Preference:</div>
                    <div class="review-value">${formData.get('gender_preference')}</div>
                </div>
                <div class="review-item">
                    <div class="review-label">Scent:</div>
                    <div class="review-value">${formData.get('scent_preference')}</div>
                </div>
                <div class="review-item">
                    <div class="review-label">Deodorant Type:</div>
                    <div class="review-value">${formData.get('deodorant_type')}</div>
                </div>
                <div class="review-item">
                    <div class="review-label">Style:</div>
                    <div class="review-value">${formData.get('style_preference')}</div>
                </div>
                <div class="review-item">
                    <div class="review-label">Bedding Color:</div>
                    <div class="review-value">${formData.get('bedding_color')}</div>
                </div>
                <div class="review-item">
                    <div class="review-label">Pillow Firmness:</div>
                    <div class="review-value">${formData.get('pillow_firmness')}</div>
                </div>
                <div class="review-item">
                    <div class="review-label">Towel Color:</div>
                    <div class="review-value">${formData.get('towel_color')}</div>
                </div>
                <div class="review-item">
                    <div class="review-label">Slides Size:</div>
                    <div class="review-value">${formData.get('slides_size')}</div>
                </div>
            `;
            document.getElementById('review-products').innerHTML = productsHTML;
        }

        // ZIP code lookup with confirmation
        let zipLookupData = null;

        async function lookupZip(zip) {
            try {
                const response = await fetch(`https://api.zippopotam.us/us/${zip}`);
                if (!response.ok) throw new Error('ZIP not found');
                const data = await response.json();
                if (data.places && data.places[0]) {
                    return {
                        city: data.places[0]['place name'],
                        state: data.places[0]['state abbreviation']
                    };
                }
            } catch (error) {
                console.log('ZIP lookup failed:', error);
            }
            return null;
        }

        function applyZipLookup(data) {
            if (data) {
                document.getElementById('city').value = data.city;
                document.getElementById('state').value = data.state;
                zipLookupData = null;
            }
        }

        document.getElementById('zip').addEventListener('blur', async function() {
            const zip = this.value;
            const zipRegex = /^\d{5}$/;
            
            if (!zipRegex.test(zip)) {
                return;
            }

            const data = await lookupZip(zip);
            
            if (data) {
                const currentCity = document.getElementById('city').value.trim();
                const currentState = document.getElementById('state').value.trim();
                
                // Normalize for comparison (case-insensitive, handle common variations)
                const normalizeCity = (city) => city.toLowerCase().replace(/\./g, '').replace(/\s+/g, ' ').trim();
                const apiCityNorm = normalizeCity(data.city);
                const currentCityNorm = normalizeCity(currentCity);
                const apiStateUpper = data.state.toUpperCase();
                const currentStateUpper = currentState.toUpperCase();
                
                // Check if fields are empty OR if they differ from ZIP lookup
                const fieldsEmpty = currentCity === '' && currentState === '';
                const cityMatches = currentCityNorm === apiCityNorm;
                const stateMatches = currentStateUpper === apiStateUpper;
                const valuesMatch = cityMatches && stateMatches;
                
                if (fieldsEmpty) {
                    // Fields are empty, just fill them
                    applyZipLookup(data);
                } else if (!valuesMatch) {
                    // Values differ, prompt user
                    zipLookupData = data;
                    const shouldUpdate = confirm(
                        `We found this location for ZIP code ${zip}:\n\n` +
                        `${data.city}, ${data.state}\n\n` +
                        `Your current address shows:\n` +
                        `${currentCity}, ${currentState}\n\n` +
                        `Would you like to update to the ZIP code's location?`
                    );
                    
                    if (shouldUpdate) {
                        applyZipLookup(data);
                    }
                }
                // If valuesMatch is true, do nothing (ZIP matches existing data)
            }
       });
        
        // === ENHANCEMENT: Live ZIP Validation Feedback ===
        const zipInput = document.getElementById('zip');
        const zipLiveFeedback = document.getElementById('zip-live-feedback');

        zipInput.addEventListener('input', function() {
            // Check only if input is not empty
            if (this.value.trim() === '') {
                zipLiveFeedback.style.display = 'none';
                return;
            }

            // Use the imported function for live validation
            if (!window.isValidZip(this.value)) {
                zipLiveFeedback.style.display = 'block';
            } else {
                zipLiveFeedback.style.display = 'none';
            }
        });
        // === END ENHANCEMENT ===

        // State auto-uppercase
        document.getElementById('state').addEventListener('input', function() {
            this.value = this.value.toUpperCase();
        });
        
        // === ENHANCEMENT: Live Email Validation Feedback ===
        const emailInput = document.getElementById('email');
        const emailLiveFeedback = document.getElementById('email-live-feedback');

        emailInput.addEventListener('input', function() {
            // Check only if input is not empty
            if (this.value.trim() === '') {
                emailLiveFeedback.style.display = 'none';
                emailInput.classList.remove('invalid');
                return;
            }

            // Use the imported function for live validation - now returns {valid, message}
            const result = window.isValidEmail(this.value);
            if (!result.valid) {
                emailLiveFeedback.textContent = result.message;
                emailLiveFeedback.style.display = 'block';
                emailInput.classList.add('invalid');
            } else {
                emailLiveFeedback.style.display = 'none';
                emailInput.classList.remove('invalid');
            }
        });

        emailInput.addEventListener('blur', function() {
            // Revalidate on blur for immediate feedback
            if (this.value.trim() !== '') {
                const result = window.isValidEmail(this.value);
                if (!result.valid) {
                    emailLiveFeedback.textContent = result.message;
                    emailLiveFeedback.style.display = 'block';
                    emailInput.classList.add('invalid');
                }
            }
        });
        // === END ENHANCEMENT ===
        
        // Form submission
        document.getElementById('kitForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            // Validate all sections
            if (!validateSection(1) || !validateSection(2)) {
                alert('Please complete all required fields.');
                return;
            }

            // Show loading overlay
            document.getElementById('loadingOverlay').classList.add('show');

            // Get form data
            const formData = new FormData(this);
            const data = {};
            formData.forEach((value, key) => {
                data[key] = value;
            });

            // Add timestamp
            data.timestamp = new Date().toISOString();

            // TESTING: To preview the success page without submitting, uncomment these 3 lines:
            // showSuccessPage();
            // document.getElementById('loadingOverlay').classList.remove('show');
            // return;

            try {
    // Submit through Vercel proxy (which forwards to Google Apps Script)
const response = await fetch('https://grant-fulfillment-proxy.vercel.app/api/proxy', {
    method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    });

    const result = await response.json();
    
    // Check if submission was successful
    if (result.status === 'success') {
        showSuccessPage();
    } else {
        throw new Error(result.message || 'Submission failed');
    }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loadingOverlay').classList.remove('show');
                alert('There was an error submitting your form. Please try again.');
            }
        });

    // Function to show success page
     function showSuccessPage() {
            // Update progress bar FIRST - mark step 4 as complete
            document.getElementById('step-3').classList.remove('active');
            document.getElementById('step-3').classList.add('complete');
            document.getElementById('step-4').classList.add('complete');
            document.getElementById('step-4').classList.add('active');
            
            // Small delay to ensure progress bar updates are rendered
            setTimeout(() => {
                // Hide loading
                document.getElementById('loadingOverlay').classList.remove('show');
                
                // Hide form
                document.getElementById('kitForm').style.display = 'none';
                
                // KEEP progress bar visible - don't hide it
                // Students should see all 4 steps complete
                
                // Show success screen
                document.getElementById('successScreen').classList.add('show');
                
                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }, 50);
        }
       // ============================================================
        // EMAIL VERIFICATION LOGIC
        // ============================================================

        let studentData = null; // Store student info after verification

        document.addEventListener('DOMContentLoaded', function() {
            // Email verification button handler
            document.getElementById('verifyEmailBtn').addEventListener('click', async function() {
                const emailInput = document.getElementById('email_verify');
                const email = emailInput.value.trim();
                const errorDiv = document.getElementById('email-verify-error');
                const checkingDiv = document.getElementById('email-checking');
                const btn = this;
                
                // Clear previous errors
                errorDiv.style.display = 'none';
                errorDiv.textContent = '';
                emailInput.classList.remove('invalid');
                
                // Validate email format
                const validation = window.isValidEmail(email);
                if (!validation.valid) {
                    errorDiv.textContent = validation.message;
                    errorDiv.style.display = 'block';
                    emailInput.classList.add('invalid');
                    return;
                }
                
                // Show checking status
                btn.disabled = true;
                checkingDiv.style.display = 'block';
                
                try {
                    // Call Vercel proxy to check student status
const response = await fetch('https://grant-fulfillment-proxy.vercel.app/api/proxy', {
                    method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            action: 'checkStudentStatus',
                            email: email
                        })
                    });
                    
                   const result = await response.json();
                    
                    // IMPORTANT: Proxy wraps response in { status: 'success', data: {...} }
                    // So we need to access result.data to get the actual Apps Script response
                    const studentStatus = result.data || result;
                    
                    // Hide checking status
                    checkingDiv.style.display = 'none';
                    btn.disabled = false;
                    
                    if (studentStatus.status === 'not_found') {
                        // Email not in Grant_Recipients
                        errorDiv.textContent = 'Email not found. Please check your email or contact hello@campusready.foundation';
                        errorDiv.style.display = 'block';
                        emailInput.classList.add('invalid');
                        
                    } else if (studentStatus.status === 'found') {
                        // Store student data for later use
                        studentData = studentStatus;
                        
                        // Determine what to show based on document status
                        handleStudentStatus(studentStatus);
                    }
                    
                } catch (error) {
                    console.error('Error verifying email:', error);
                    checkingDiv.style.display = 'none';
                    btn.disabled = false;
                    errorDiv.textContent = 'Unable to verify email. Please try again or contact hello@campusready.foundation';
                    errorDiv.style.display = 'block';
                }
            });
    });
    function handleStudentStatus(data) {
            // Store student data for later use
            studentData = data;
        
                   const housingStatus = data.housingStatus || 'Pending';
            const acceptanceStatus = data.acceptanceStatus || 'Pending';
            
            // Hide email validation section
            document.getElementById('emailValidation').style.display = 'none';
            
          // Both documents approved - skip to item selection
if (housingStatus === 'Approved' && acceptanceStatus === 'Approved') {
    document.querySelector('[data-section="1"]').classList.add('active');
 updateHeader('Customize Your Kit', "We're going shopping! Your responses will guide us to select items that match your style, ensuring you get products you want for the start to your college journey.");   
    // Auto-populate fields for already-approved students
    setTimeout(() => {
        const nameField = document.getElementById('student_name');
        const emailField = document.getElementById('email');
        
        if (nameField && studentData && studentData.studentName) {
            nameField.value = studentData.studentName;
            nameField.readOnly = true;
            nameField.style.backgroundColor = '#f0f0f0';
            nameField.style.cursor = 'not-allowed';
        }
        
        if (emailField && studentData && studentData.email) {
            emailField.value = studentData.email;
            emailField.readOnly = true;
            emailField.style.backgroundColor = '#f0f0f0';
            emailField.style.cursor = 'not-allowed';
        }
    }, 100);
                
            // At least one document rejected - show upload with message
            } else if (housingStatus === 'Rejected' || acceptanceStatus === 'Rejected') {
                document.getElementById('documentUpload').style.display = 'block';
                updateHeader('College & Housing Verification', 'Before we customize your kit, we need two quick documents. Please upload these by June 30th.');
                // TODO: Add rejection message styling in Phase 4
                
            // Documents uploaded, under review - show waiting message
            } else if (housingStatus === 'Uploaded' || acceptanceStatus === 'Uploaded') {
                alert("Your documents are being reviewed. Don't worry, we'll email you when they're approved.");
                // TODO: Build proper waiting UI in Phase 4
                
            // First time or both pending - show upload section
            } else {
                document.getElementById('documentUpload').style.display = 'block';
                updateHeader('College & Housing Verification', 'Before we customize your kit, we need two quick documents. Please upload these by June 30th.');
            }
            
            // Update progress bar
            document.getElementById('step-1').classList.add('complete');
            document.getElementById('step-2').classList.add('active');
        }
        // File validation and upload handlers
        let housingFileData = null;
        let acceptanceFileData = null;

        // Validate file type and size
        function validateFile(file) {
            const validTypes = ['application/pdf', 'image/jpeg', 'image/png', 'image/jpg'];
            const maxSize = 5 * 1024 * 1024; // 5MB

            if (!validTypes.includes(file.type)) {
                return { valid: false, error: 'Oops - we can only accept PDF, JPG, or PNG files. Please select a different file.' };
            }

            if (file.size > maxSize) {
                return { valid: false, error: 'This file is a bit too large (over 5MB). Try compressing it or taking a clearer photo.' };
            }

            return { valid: true };
        }

        // Convert file to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Housing document handler
        document.getElementById('housing_doc').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const validation = validateFile(file);
            if (!validation.valid) {
                document.getElementById('housing_error').textContent = validation.error;
                document.getElementById('housing_filename').textContent = '';
                return;
            }

            document.getElementById('housing_error').textContent = '';
            document.getElementById('housing_filename').textContent = file.name;
            housingFileData = { name: file.name, data: await fileToBase64(file) };
            checkBothFilesSelected();
        });

        // Acceptance document handler
        document.getElementById('acceptance_doc').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const validation = validateFile(file);
            if (!validation.valid) {
                document.getElementById('acceptance_error').textContent = validation.error;
                document.getElementById('acceptance_filename').textContent = '';
                return;
            }

            document.getElementById('acceptance_error').textContent = '';
            document.getElementById('acceptance_filename').textContent = file.name;
            acceptanceFileData = { name: file.name, data: await fileToBase64(file) };
            checkBothFilesSelected();
        });

        // Check if both files are selected
        function checkBothFilesSelected() {
            const continueBtn = document.getElementById('continueToKitBtn');
            if (housingFileData && acceptanceFileData) {
                continueBtn.disabled = false;
            }
        }

        // Continue to kit selection button
        document.getElementById('continueToKitBtn').addEventListener('click', async function() {
            await uploadDocuments();
        });

        // Upload documents to Apps Script
        async function uploadDocuments() {
      // Show progress indicators
document.getElementById('housing_progress').style.display = 'block';
document.getElementById('acceptance_progress').style.display = 'block';

// Rotating progress messages
const messages = [
    'Sending your documents...',
    'Almost there...',
    'Preparing to be prepared...'
];
let messageIndex = 0;

// Update housing progress text with rotating messages
const rotateMessages = setInterval(() => {
    document.getElementById('housing_progress_text').textContent = messages[messageIndex];
    document.getElementById('acceptance_progress_text').textContent = messages[messageIndex];
    messageIndex = (messageIndex + 1) % messages.length;
}, 1200); // Rotate every 1.2 seconds
            try {
const response = await fetch('https://grant-fulfillment-proxy.vercel.app/api/proxy', {
                method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'uploadDocuments',
                        email: studentData.email,
                        applicationId: studentData.applicationId,
                        housingFile: housingFileData,
                        acceptanceFile: acceptanceFileData
                    })
                });

               const result = await response.json();
console.log('Upload response:', result);
const data = result; // Apps Script direct (no proxy wrapper)
console.log('Processed data:', data); // Log processed data

if (data.status === 'success') {
                clearInterval(rotateMessages); // Stop rotating messages
                    document.getElementById('housing_progress').style.display = 'none';
                    document.getElementById('acceptance_progress').style.display = 'none';
                    document.getElementById('housing_success').style.display = 'block';
                    document.getElementById('acceptance_success').style.display = 'block';

                   // Add celebration message
const celebrationMsg = document.createElement('div');
celebrationMsg.style.cssText = 'margin-top: 20px; padding: 16px; background: #ECFDF5; border: 2px solid #469E92; border-radius: 8px; color: #065F46; font-weight: 500; text-align: center;';
celebrationMsg.textContent = 'Perfect! Now the fun starts. Let\'s customize your kit.';
document.getElementById('documentUpload').appendChild(celebrationMsg);

// Hide the original "Continue to Kit Selection" button
document.getElementById('continueToKitBtn').style.display = 'none';

// Add button to continue to personalization
const continueButton = document.createElement('button');
continueButton.type = 'button';
continueButton.className = 'btn btn-primary';
continueButton.textContent = 'Continue to Personalize Your Kit';
continueButton.style.cssText = 'margin-top: 20px; width: 100%;';
continueButton.onclick = function() {
    // Hide document upload section
    document.getElementById('documentUpload').style.display = 'none';
    
    // Show personalization section
    document.querySelector('[data-section="1"]').classList.add('active');
updateHeader('Customize Your Kit', "We're going shopping. Your responses will guide us to select items that match your style, ensuring you get products you want for the start to your college journey.");    
    // Small delay to ensure DOM is fully rendered
    setTimeout(() => {
        // Auto-populate name and email
        const nameField = document.getElementById('student_name');
        const emailField = document.getElementById('email');
        
        if (nameField && studentData && studentData.studentName) {
            nameField.value = studentData.studentName;
            nameField.readOnly = true;
            nameField.style.backgroundColor = '#f0f0f0';
            nameField.style.cursor = 'not-allowed';
        }
        
        if (emailField && studentData && studentData.email) {
            emailField.value = studentData.email;
            emailField.readOnly = true;
            emailField.style.backgroundColor = '#f0f0f0';
            emailField.style.cursor = 'not-allowed';
        }
        
        // Scroll to top of form
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }, 100); // Short delay just to ensure section is visible
    
    // Update progress bar
    document.getElementById('step-2').classList.add('complete');
    document.getElementById('step-3').classList.add('active');
};
document.getElementById('documentUpload').appendChild(continueButton);
        } else {
                    throw new Error(data.message || 'Upload failed');
                }
           } catch (error) {
    clearInterval(rotateMessages); // Stop rotating messages
    console.error('Upload error:', error); // Log the actual error
    console.error('Error details:', error.message); // Log error message
    document.getElementById('housing_progress').style.display = 'none';
    document.getElementById('acceptance_progress').style.display = 'none';
    document.getElementById('housing_error').innerHTML = 'Hmm, something went wrong. Please try uploading again. If this keeps happening, email us at <a href="mailto:hello@campusready.foundation" style="color: #469E92; text-decoration: underline;">hello@campusready.foundation</a>';
}
        }
        function submitForm() {
  const formData = {
    student_name: document.getElementById('student_name').value,
    email: document.getElementById('email').value,
    shipping_preference: document.querySelector('input[name="shipping_preference"]:checked')?.value,
    street_address: document.getElementById('street_address').value,
    street_address_2: document.getElementById('street_address_2').value,
    city: document.getElementById('city').value,
    state: document.getElementById('state').value,
    zip: document.getElementById('zip').value,
    gender_preference: document.querySelector('input[name="gender_preference"]:checked')?.value,
    scent_preference: document.querySelector('input[name="scent_preference"]:checked')?.value,
    deodorant_type: document.querySelector('input[name="deodorant_type"]:checked')?.value,
    style_preference: document.querySelector('input[name="style_preference"]:checked')?.value,
    bedding_color: document.querySelector('input[name="bedding_color"]:checked')?.value,
    pillow_firmness: document.querySelector('input[name="pillow_firmness"]:checked')?.value,
    towel_color: document.querySelector('input[name="towel_color"]:checked')?.value,
    slides_size: document.querySelector('input[name="slides_size"]:checked')?.value,
    timestamp: new Date().toISOString()
  };

  // Show loading overlay
  document.getElementById('loadingOverlay').classList.add('show');

fetch('https://grant-fulfillment-proxy.vercel.app/api/proxy', {
    method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(formData)
})
  .then(response => response.json())
  .then(data => {
    document.getElementById('loadingOverlay').classList.remove('show');
    if (data.status === 'success') {
      document.getElementById('kitForm').style.display = 'none';
      document.getElementById('successScreen').classList.add('show');
    } else {
      console.error('Submission error:', data.message);
      alert('There was an error submitting your form. Please try again.');
    }
  })
  .catch(error => {
    document.getElementById('loadingOverlay').classList.remove('show');
    console.error('Network error:', error);
    alert('Network error. Please check your connection and try again.');
  });
}
    </script>


<script>
// ============================================================
// VALIDATION FUNCTIONS (Inlined for reliability)
// ============================================================
// These functions were previously in /assets/js/validation.js
// but are now inlined to eliminate external dependencies

// EMAIL VALIDATION - Full featured version matching index.html
window.isValidEmail = function(email) {
    const val = (email || '').trim();
    if (!val) return { valid: false, message: 'Email is required.' };

    // 1. Structural Check: Single @
    const atIndex = val.indexOf('@');
    if (atIndex <= 0 || atIndex !== val.lastIndexOf('@') || atIndex === val.length - 1) {
        return { valid: false, message: 'Email must contain a single @ (e.g., name@example.com).' };
    }

    const parts = val.split('@');
    const local = parts[0], domain = parts[1];

    // 2. Local Part Rules: (Cannot start/end with dot, no control characters, etc.)
    if (!local || local.length > 64 || local.startsWith('.') || local.endsWith('.')) {
        return { valid: false, message: 'The part before @ looks invalid.' };
    }
    if (local.includes('..')) {
        return { valid: false, message: 'The part before @ looks invalid.' };
    }
    for (const ch of local) {
        const code = ch.charCodeAt(0);
        if (code <= 31 || code === 127 || [' ', '"', '\\', '<', '>'].includes(ch)) {
            return { valid: false, message: 'The part before @ looks invalid.' };
        }
    }

    // 3. Domain Part Rules: (At least two labels, no illegal chars/hyphens)
    if (!domain) {
        return { valid: false, message: 'The domain after @ looks invalid.' };
    }
    const labels = domain.split('.');
    if (labels.length < 2) {
        return { valid: false, message: 'The domain after @ looks invalid.' };
    }

    for (const lab of labels) {
        if (!lab || lab.length > 63 || lab.startsWith('-') || lab.endsWith('-')) {
            return { valid: false, message: 'The domain after @ looks invalid.' };
        }
        // Allows letters, numbers, and hyphens (and unicode as per RFC)
        if (/[^0-9A-Za-z\u00C0-\uFFFF-]/.test(lab)) {
            return { valid: false, message: 'The domain after @ looks invalid.' };
        }
    }

    // 4. TLD validation and typo detection
    const tld = labels[labels.length - 1].toLowerCase();
    if (tld.length < 2) {
        return { valid: false, message: 'The domain after @ looks invalid.' };
    }
    
    // Block TLDs with numbers (almost always invalid)
    if (/\d/.test(tld)) {
        return { valid: false, message: 'The domain after @ looks invalid.' };
    }
    
    // Block TLDs longer than 6 characters (likely typos)
    if (tld.length > 6) {
        return { valid: false, message: 'The domain after @ looks invalid.' };
    }
    
    // Check for specific common typo TLDs with helpful message
    if (tld === 'con' || tld === 'cmo' || tld === 'ocm') {
        return { valid: false, message: 'Top-level domain looks wrong: "' + tld + '". Did you mean ".com"?' };
    }
    
    // Blocks other common typos
    const badTLD = ['comm', 'cpm', 'xom', 'vom', 'cim', 'cin', 'xeres', 'nett', 'orgg', 'gom'];
    if (badTLD.includes(tld)) {
        return { valid: false, message: 'The domain after @ looks invalid.' };
    }
    
    // 5. Domain suggestion for common typos
    const domainSuggestions = {
        'gamil.com': 'gmail.com',
        'gmial.com': 'gmail.com',
        'gmai.com': 'gmail.com',
        'hotnail.com': 'hotmail.com',
        'hotmial.com': 'hotmail.com',
        'hotmai.com': 'hotmail.com',
        'yahho.com': 'yahoo.com',
        'yaho.com': 'yahoo.com',
        'yahooo.com': 'yahoo.com',
        'outlok.com': 'outlook.com',
        'outloo.com': 'outlook.com',
        'iclouds.com': 'icloud.com',
        'iclould.com': 'icloud.com',
        'iclou.com': 'icloud.com'
    };
    
    const domainLower = domain.toLowerCase();
    if (domainSuggestions[domainLower]) {
        return { valid: false, message: 'Did you mean ' + local + '@' + domainSuggestions[domainLower] + '?' };
    }
    
    return { valid: true, message: '' };
};

window.isValidZip = function(zip) {
    // Allow 5-digit or ZIP+4 with optional hyphen
    return /^\d{5}(-\d{4})?$/.test(String(zip || '').trim());
};

window.doesZipMatchCityState = async function(zip, city, state) {
    // Normalize inputs
    const zip5 = String(zip || '').trim().slice(0, 10).replace(/\D/g, '').slice(0, 5); // use 5-digit portion
    const st  = String(state || '').trim().toUpperCase(); // USPS 2-letter
    const normCity = (s) => {
        let x = String(s || '').toLowerCase();
        x = x.replace(/\./g, '');        // drop periods: "St." -> "St"
        x = x.replace(/\s+/g, ' ').trim();
        // Expand common prefixes to reduce false mismatches
        x = x.replace(/^st\s+/, 'saint ');
        x = x.replace(/^ste\s+/, 'sainte ');
        return x;
    };
    const c = normCity(city);

    try {
        if (!zip5 || zip5.length !== 5) return false;
        const response = await fetch(`https://api.zippopotam.us/us/${zip5}`);
        if (!response.ok) return false;

        const data = await response.json();
        const places = Array.isArray(data.places) ? data.places : [];

        return places.some(place => {
            const apiCity  = normCity(place['place name']);
            const apiState = String(place['state abbreviation'] || '').toUpperCase();
            // Match on exact state, and city after normalization
            return apiState === st && apiCity === c;
        });
    } catch (error) {
        console.error('ZIP lookup failed:', error);
        return false;
    }
};
</script>
    
</body>
</html>
